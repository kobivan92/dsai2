{% extends "base.html" %}

{% block content %}
<h1 class="mb-4">Bias Analysis Tool</h1>

<form id="analysisForm" class="mb-4">
    <div class="mb-3">
        <label for="file" class="form-label">CSV File</label>
        <input type="file" class="form-control" id="file" name="file" accept=".csv" required>
        <div id="fileInfo" class="file-info"></div>
    </div>
    
    <div class="mb-3">
        <label for="columns_description" class="form-label">Columns Description</label>
        <textarea class="form-control" id="columns_description" name="columns_description" rows="4" required></textarea>
        <div class="form-text">Describe the columns in your dataset for the LLM to understand.</div>
    </div>
    
    <div class="row">
        <div class="col-md-4 mb-3">
            <label for="n_rows" class="form-label">Number of Rows</label>
            <input type="number" class="form-control" id="n_rows" name="n_rows" value="10000" min="0">
            <div class="form-text">0 for all rows</div>
        </div>
        
        <div class="col-md-4 mb-3">
            <label for="test_size" class="form-label">Test Size</label>
            <input type="number" class="form-control" id="test_size" name="test_size" value="0.3" min="0.1" max="0.9" step="0.1">
        </div>
        
        <div class="col-md-4 mb-3">
            <label for="max_categories" class="form-label">Max Categories</label>
            <input type="number" class="form-control" id="max_categories" name="max_categories" value="10" min="1">
            <div class="form-text">Maximum categories per feature</div>
        </div>
    </div>
    
    <button type="submit" class="btn btn-primary">Analyze</button>
</form>

<div id="loading" class="loading">
    <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">Loading...</span>
    </div>
    <p class="mt-2">Analyzing data...</p>
</div>

<div id="error" class="error alert alert-danger"></div>

<div id="recommendations" class="recommendations">
    <h3>LLM Recommendations</h3>
    <div class="mb-3">
        <strong>Target Column:</strong>
        <span id="targetColumn"></span>
    </div>
    <div class="mb-3">
        <strong>Protected Attributes:</strong>
        <ul id="protectedAttributes"></ul>
    </div>
    <div class="mb-3">
        <strong>Excluded Columns:</strong>
        <ul id="excludedColumns"></ul>
    </div>
    <div>
        <strong>Top Correlated Features:</strong>
        <pre id="correlations" style="background-color: #f8f9fa; padding: 10px; border-radius: 4px;"></pre>
    </div>
</div>

<div id="results" class="results">
    <h2>Analysis Results</h2>
    <div id="resultsContent"></div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Function to update file info display
function updateFileInfo(message, isCached = false) {
    const fileInfo = document.getElementById('fileInfo');
    fileInfo.style.display = 'block';
    fileInfo.innerHTML = message;
    fileInfo.className = `file-info ${isCached ? 'alert alert-info' : 'alert alert-success'}`;
}

// Function to display LLM recommendations
function displayRecommendations(recommendations) {
    // Clear previous content
    document.getElementById('recommendations').innerHTML = '<h3>LLM Recommendations</h3>';
    
    // Basic recommendations
    let content = `
        <div class="mb-3">
            <strong>Target Column:</strong>
            <span id="targetColumn">${recommendations.target_column}</span>
        </div>
        <div class="mb-3">
            <strong>Protected Attributes:</strong>
            <ul id="protectedAttributes">
                ${recommendations.protected_columns.split(',').map(attr => `<li>${attr.trim()}</li>`).join('')}
            </ul>
        </div>
        <div class="mb-3">
            <strong>Excluded Columns:</strong>
            <ul id="excludedColumns">
                ${recommendations.excluded_columns.split(',').map(col => `<li>${col.trim()}</li>`).join('')}
            </ul>
        </div>
        <div class="mb-3">
            <strong>Top Correlated Features:</strong>
            <pre id="correlations" style="background-color: #f8f9fa; padding: 10px; border-radius: 4px;">${recommendations.correlations}</pre>
        </div>
    `;
    
    // Add race column and groups if available
    if (recommendations.race_column) {
        content += `<div class="mb-3"><strong>Race Column for AIF Metrics:</strong> ${recommendations.race_column}</div>`;
    }
    if (recommendations.privileged_list && recommendations.privileged_list.length > 0) {
        content += `
            <div class="mb-3">
                <strong>Privileged Groups:</strong>
                <ul>${recommendations.privileged_list.map(g => `<li>${g}</li>`).join('')}</ul>
            </div>
        `;
    }
    if (recommendations.unprivileged_list && recommendations.unprivileged_list.length > 0) {
        content += `
            <div class="mb-3">
                <strong>Unprivileged Groups:</strong>
                <ul>${recommendations.unprivileged_list.map(g => `<li>${g}</li>`).join('')}</ul>
            </div>
        `;
    }
    
    // Add AIF metrics table if present
    if (recommendations.aif_metrics && recommendations.aif_metrics.length > 0) {
        content += `
            <div class="mb-3">
                <strong>AIF360 Bias Metrics:</strong>
                <div class="table-responsive">
                    <table class="table table-striped table-hover">
                        <thead>
                            <tr>
                                <th>Category</th>
                                <th>Privileged Rate</th>
                                <th>Unprivileged Rate</th>
                                <th>Statistical Parity Difference</th>
                                <th>Disparate Impact</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${recommendations.aif_metrics.map(metric => `
                                <tr>
                                    <td>${metric.Category}</td>
                                    <td>${Number(metric['Privileged Rate']).toFixed(3)}</td>
                                    <td>${Number(metric['Unprivileged Rate']).toFixed(3)}</td>
                                    <td>${Number(metric['Statistical Parity Difference']).toFixed(3)}</td>
                                    <td>${Number(metric['Disparate Impact']).toFixed(3)}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            </div>
        `;
    }
    
    // Update the recommendations section
    document.getElementById('recommendations').insertAdjacentHTML('beforeend', content);
    document.getElementById('recommendations').style.display = 'block';
}

// Function to display analysis results
function displayResults(result) {
    console.log('displayResults called with:', result);
    const resultsDiv = document.getElementById('results');
    resultsDiv.style.display = 'block';
    resultsDiv.innerHTML = '';
    if (!result.results || Object.keys(result.results).length === 0) {
        resultsDiv.innerHTML = '<div class="alert alert-warning">No analysis results to display.</div>';
        return;
    }
    // Create container for each protected attribute
    for (const [attr, data] of Object.entries(result.results)) {
        const attrContainer = document.createElement('div');
        attrContainer.className = 'mb-5 p-4 border rounded shadow-sm';
        
        // Add header for this protected attribute
        const header = document.createElement('h3');
        header.className = 'mb-4';
        header.textContent = `Analysis for Protected Attribute: ${attr}`;
        attrContainer.appendChild(header);

        // Overall metrics (precision and recall only)
        const overallSection = document.createElement('div');
        overallSection.className = 'mb-4';
        overallSection.innerHTML = `
            <h4 class="mb-3">Overall Metrics</h4>
            <div class="table-responsive">
                <table class="table table-striped table-hover">
                    <thead>
                        <tr>
                            <th>Class</th>
                            <th>Precision</th>
                            <th>Recall</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${Object.entries(data.overall).map(([cls, metrics]) => `
                            <tr>
                                <td>${cls}</td>
                                <td>${Number(metrics.precision).toFixed(3)}</td>
                                <td>${Number(metrics.recall).toFixed(3)}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            </div>
        `;
        attrContainer.appendChild(overallSection);

        // Group-wise metrics (precision and recall only)
        const groupSection = document.createElement('div');
        groupSection.className = 'mb-4';
        groupSection.innerHTML = `
            <h4 class="mb-3">Group-wise Metrics</h4>
            <div class="table-responsive">
                <table class="table table-striped table-hover">
                    <thead>
                        <tr>
                            <th>${attr}</th>
                            <th>Class</th>
                            <th>Precision</th>
                            <th>Recall</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${data.group_report.map(row => `
                            <tr>
                                <td>${row[attr]}</td>
                                <td>${row.class}</td>
                                <td>${Number(row.precision).toFixed(3)}</td>
                                <td>${Number(row.recall).toFixed(3)}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            </div>
        `;
        attrContainer.appendChild(groupSection);

        // AIF360 Bias Metrics if available
        if (data.bias_metrics) {
            const biasSection = document.createElement('div');
            biasSection.className = 'mb-4';
            biasSection.innerHTML = `
                <h4 class="mb-3">Bias Metrics</h4>
                <div class="table-responsive">
                    <table class="table table-striped table-hover">
                        <thead>
                            <tr>
                                <th>Category</th>
                                <th>Privileged Rate</th>
                                <th>Unprivileged Rate</th>
                                <th>Statistical Parity Difference</th>
                                <th>Disparate Impact</th>
                                <th>Mean Difference</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${data.bias_metrics.map(metric => `
                                <tr>
                                    <td>${metric.Category}</td>
                                    <td>${Number(metric['Privileged Rate']).toFixed(3)}</td>
                                    <td>${Number(metric['Unprivileged Rate']).toFixed(3)}</td>
                                    <td>${Number(metric['Statistical Parity Difference']).toFixed(3)}</td>
                                    <td>${Number(metric['Disparate Impact']).toFixed(3)}</td>
                                    <td>${Number(metric['Mean Difference']).toFixed(3)}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
            attrContainer.appendChild(biasSection);
        }

        // SHAP Analysis for each class
        if (data.shap_tables) {
            for (const [cls, shapTable] of Object.entries(data.shap_tables)) {
                const shapSection = document.createElement('div');
                shapSection.className = 'mb-4';
                shapSection.innerHTML = `
                    <h4 class="mb-3">SHAP Analysis for Class: ${cls}</h4>
                    <div class="table-responsive">
                        <table class="table table-striped table-hover">
                            <thead>
                                <tr>
                                    <th>Row ID</th>
                                    <th>Feature</th>
                                    <th>Feature Value</th>
                                    <th>Base Value</th>
                                    <th>SHAP Value</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${shapTable.slice(0, 100).map(row => `
                                    <tr>
                                        <td>${row.row_id}</td>
                                        <td>${row.feature}</td>
                                        <td>${row.feature_value}</td>
                                        <td>${Number(row.base_value).toFixed(3)}</td>
                                        <td>${Number(row.shap_value).toFixed(3)}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                `;
                attrContainer.appendChild(shapSection);
            }
        }

        resultsDiv.appendChild(attrContainer);
    }
}

// Event Listeners
document.getElementById('file').addEventListener('change', function(e) {
    const file = e.target.files[0];
    if (file) {
        updateFileInfo(`Selected file: ${file.name}`);
    }
});

document.getElementById('analysisForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const form = e.target;
    const formData = new FormData(form);
    
    // Show loading, hide results and error
    document.getElementById('loading').style.display = 'block';
    document.getElementById('results').style.display = 'none';
    document.getElementById('error').style.display = 'none';
    document.getElementById('recommendations').style.display = 'none';
    
    try {
        // Validate required fields
        const file = formData.get('file');
        const columnsDescription = formData.get('columns_description');
        
        if (!file) {
            throw new Error('Please select a CSV file');
        }
        if (!columnsDescription) {
            throw new Error('Please provide a description of the columns');
        }
        
        // Convert numeric values to proper format
        const nRows = parseInt(formData.get('n_rows')) || 0;
        const testSize = parseFloat(formData.get('test_size')) || 0.3;
        const maxCategories = parseInt(formData.get('max_categories')) || 10;
        
        // Create a new FormData with validated values
        const validatedFormData = new FormData();
        validatedFormData.append('file', file);
        validatedFormData.append('columns_description', columnsDescription);
        validatedFormData.append('n_rows', nRows);
        validatedFormData.append('test_size', testSize);
        validatedFormData.append('max_categories', maxCategories);
        
        const response = await fetch('/analyze', {
            method: 'POST',
            body: validatedFormData
        });
        
        if (!response.ok) {
            const errorData = await response.json();
            throw new Error(errorData.message || 'Server error occurred');
        }
        
        const data = await response.json();
        
        if (data.status === 'error') {
            throw new Error(data.message);
        }
        
        // Update file info to show if cached
        updateFileInfo(`Using file: ${file.name}${data.is_cached ? ' (cached)' : ''}`, data.is_cached);
        
        // Display recommendations and results
        displayRecommendations(data.llm_recommendations);
        displayResults(data);
        
    } catch (error) {
        console.error('Error:', error);
        document.getElementById('error').textContent = error.message || 'An error occurred during analysis';
        document.getElementById('error').style.display = 'block';
    } finally {
        document.getElementById('loading').style.display = 'none';
    }
});
</script>
{% endblock %} 